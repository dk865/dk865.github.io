<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vimidio - MIDI Visualizer</title>
<style>
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @font-face {
        font-family: 'Carter One';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url('./fonts/CarterOne-Regular.woff2') format('woff2');
    }

    body {
        font-family: 'Carter One', sans-serif;
        text-align: center;
        background: linear-gradient(45deg, #001c2c, #002d4c, #004080);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0;
        color: #fff;
        overflow: hidden;
    }

    .visualizer {
        position: relative;
        width: 80%;
        height: 60%;
        border: 2px solid #ffffff;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .note {
        position: absolute;
        width: 20px;
        height: 20px;
        background: yellow;
        border-radius: 50%;
        animation: fly 1s linear forwards;
    }

    @keyframes fly {
        to {
            transform: translateY(-100vh) scale(0.5);
            opacity: 0;
        }
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #ff0;
        border-radius: 50%;
        animation: confettiFall 2s linear infinite;
    }

    @keyframes confettiFall {
        0% { transform: translateY(0); }
        100% { transform: translateY(100vh) rotate(360deg); }
    }

    .log {
        width: 80%;
        height: 20%;
        background: #eeeeee;
        border: 2px solid #888888;
        border-radius: 10px;
        padding: 10px;
        overflow: auto;
    }
</style>
</head>
<body>
<div id="visualizer" class="visualizer"></div>
<pre id="log" class="log"></pre>

<script>
    var midiAccess = null;
    var midiInputs = [];
    var midiOutputs = [];
    var visualizer = document.getElementById('visualizer');
    var logElement = document.getElementById('log');

    function setup() {
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess({ sysex: false }).then(success, function() { log("requestMIDIAccess() failed."); });
        } else {
            log("Web MIDI API is not available on your browser.");
        }

        function success(access) {
            midiAccess = access;
            midiAccess.onstatechange = onStateChange;
            setupEventHandler();
        }

        function setupEventHandler() {
            midiInputs = Array.from(midiAccess.inputs.values());
            midiOutputs = Array.from(midiAccess.outputs.values());

            midiInputs.forEach(input => {
                input.onmidimessage = function(event) {
                    handleMIDIMessage(event.data);
                };
                log(`Connected to input: ${input.name}`);
            });
        }

        function onStateChange(event) {
            if (event.port.type === "input") {
                if (event.port.state === "connected" && !midiInputs.includes(event.port)) {
                    midiInputs.push(event.port);
                    event.port.onmidimessage = function(event) {
                        handleMIDIMessage(event.data);
                    };
                    log(`Connected to input: ${event.port.name}`);
                } else if (event.port.state === "disconnected") {
                    midiInputs = midiInputs.filter(port => port !== event.port);
                    log(`Disconnected from input: ${event.port.name}`);
                }
            }
            log("MIDI port state change: " + event.port.name + " " + event.port.state);
        }
    }

    function handleMIDIMessage(data) {
        if (data[0] === 0x90 && data[2] > 0) { // Note on
            createNote();
            createConfetti();
        }
        log(`MIDI message received: ${data}`);
    }

    function createNote() {
        var note = document.createElement('div');
        note.className = 'note';
        note.style.left = (Math.random() * 100) + 'vw';
        note.style.bottom = '0';
        visualizer.appendChild(note);
        setTimeout(() => {
            visualizer.removeChild(note);
        }, 1000);
    }

    function createConfetti() {
        for (let i = 0; i < 20; i++) {
            let confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = (Math.random() * 100) + 'vw';
            confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
            visualizer.appendChild(confetti);
            setTimeout(() => {
                visualizer.removeChild(confetti);
            }, 2000);
        }
    }

    function log(message) {
        logElement.innerHTML += message + "\n";
        logElement.scrollTop = logElement.scrollHeight;
    }

    window.onload = function() {
        setup();
    }
</script>
</body>
</html>