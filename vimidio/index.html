<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vimidio - MIDI Visualizer</title>
<style>
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @font-face {
        font-family: 'Carter One';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url('./fonts/CarterOne-Regular.woff2') format('woff2');
    }

    body {
        font-family: 'Carter One', sans-serif;
        text-align: center;
        background: linear-gradient(45deg, #001c2c, #002d4c, #004080);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0;
        color: #fff;
        overflow: hidden;
    }

    .visualizer {
        position: relative;
        width: 80%;
        height: 60%;
        border: 2px solid #ffffff;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .note {
        position: absolute;
        width: 20px;
        height: 20px;
        background: yellow;
        border-radius: 50%;
        animation: fly 1s linear forwards;
    }

    @keyframes fly {
        to {
            transform: translateY(-100vh) scale(0.5);
            opacity: 0;
        }
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #ff0;
        border-radius: 50%;
        animation: confettiFall 2s linear infinite;
    }

    @keyframes confettiFall {
        0% { transform: translateY(0); }
        100% { transform: translateY(100vh) rotate(360deg); }
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5em;
        z-index: 1000;
    }

    .modal-content {
        background: #333;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 1em;
        color: white;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #0056b3;
    }
</style>
</head>
<body>
<div id="visualizer" class="visualizer"></div>
<div id="modal" class="modal">
    <div class="modal-content">
        <p>Your browser supports MIDI, but no keyboards are detectedâ€¦ Please unplug and replug it.</p>
        <button class="button" onclick="hideModal()">OK</button>
    </div>
</div>

<script>
    var midiAccess = null;
    var midiInputs = [];
    var midiOutputs = [];
    var visualizer = document.getElementById('visualizer');
    var modal = document.getElementById('modal');

    function setup() {
        console.log("Setting up MIDI access...");
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess({ sysex: false }).then(success, function() {
                console.log("MIDI access failed");
                showModal();
            });
        } else {
            console.log("Web MIDI API not supported by this browser");
            showModal();
        }

        function success(access) {
            console.log("Successfully accessed MIDI");
            midiAccess = access;
            midiAccess.onstatechange = onStateChange;
            setupEventHandler();
        }

        function setupEventHandler() {
            midiInputs = Array.from(midiAccess.inputs.values());
            midiOutputs = Array.from(midiAccess.outputs.values());

            console.log("MIDI Inputs:", midiInputs);
            console.log("MIDI Outputs:", midiOutputs);

            if (midiInputs.length === 0) {
                console.log("No MIDI inputs detected");
                showModal();
            }

            midiInputs.forEach(input => {
                input.onmidimessage = function(event) {
                    handleMIDIMessage(event.data);
                };
                console.log("Connected to input:", input.name);
            });
        }

        function onStateChange(event) {
            console.log("MIDI port state change:", event.port.name, event.port.state);
            if (event.port.type === "input") {
                if (event.port.state === "connected" && !midiInputs.includes(event.port)) {
                    midiInputs.push(event.port);
                    event.port.onmidimessage = function(event) {
                        handleMIDIMessage(event.data);
                    };
                    hideModal();
                    console.log("Input connected:", event.port.name);
                } else if (event.port.state === "disconnected") {
                    midiInputs = midiInputs.filter(port => port !== event.port);
                    if (midiInputs.length === 0) {
                        console.log("All MIDI inputs disconnected");
                        showModal();
                    }
                }
            }
        }
    }

    function handleMIDIMessage(data) {
        console.log("MIDI message received:", data);
        if (data[0] === 0x90 && data[2] > 0) { // Note on
            createNote();
            createConfetti();
        }
    }

    function createNote() {
        console.log("Creating note visual");
        var note = document.createElement('div');
        note.className = 'note';
        note.style.left = (Math.random() * 80) + 'vw';
        note.style.bottom = '0';
        visualizer.appendChild(note);
        setTimeout(() => {
            if (visualizer.contains(note)) {
                visualizer.removeChild(note);
            }
        }, 1000);
    }

    function createConfetti() {
        console.log("Creating confetti");
        for (let i = 0; i < 20; i++) {
            let confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = (Math.random() * 100) + 'vw';
            confetti.style.top = '-10px';
            confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
            visualizer.appendChild(confetti);
            setTimeout(() => {
                if (visualizer.contains(confetti)) {
                    visualizer.removeChild(confetti);
                }
            }, 2000);
        }
    }

    function showModal() {
        modal.style.display = 'flex';
    }

    function hideModal() {
        modal.style.display = 'none';
    }

    window.onload = function() {
        setup();
    }
</script>
</body>
</html>